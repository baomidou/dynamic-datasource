name: Release to Maven Central

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 步骤1：仅配置JDK，移除GPG相关参数
      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          # 移除 gpg-private-key/gpg-passphrase 参数，改为手动导入

      # 步骤2：手动配置Maven Settings（OSSRH认证）
      - name: Configure Maven Settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << EOF
          <settings>
            <servers>
              <server>
                <id>ossrh</id>
                <username>${{ secrets.OSSRH_USERNAME }}</username>
                <password>${{ secrets.OSSRH_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      # 步骤3：手动导入GPG私钥（核心修复，添加兼容参数）
      - name: Import GPG Private Key
        run: |
          # 1. 将私钥写入文件（避免管道传递的格式问题）
          echo "${{ secrets.GPG_PRIVATE_KEY }}" > private-key.asc
          # 2. 导入私钥（添加--pinentry-mode loopback避免交互，--batch静默执行）
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --pinentry-mode loopback --import private-key.asc
          # 3. 验证密钥是否导入成功（可选，调试用）
          gpg --list-secret-keys --keyid-format short

      # 步骤4：发布到Maven Central（指定GPG密钥ID和参数）
      - name: Publish to OSSRH
        run: |
          mvn clean deploy \
            -P release \
            -DskipTests \
            -Dgpg.useAgent=false \
            -Dgpg.keyname=${{ secrets.GPG_KEY_ID }} \
            -Dgpg.passphrase=${{ secrets.GPG_PASSPHRASE }} \
            -Dgpg.pinentry-mode=loopback \
            -Dgpg.batch=true
        env:
          # 仅传递OSSRH认证，GPG参数直接从Secrets读取
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_TOKEN: ${{ secrets.OSSRH_TOKEN }}